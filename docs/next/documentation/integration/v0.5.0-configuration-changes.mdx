---
title: "Configuration Changes in v0.5.0"
description: "Detailed breakdown of all configuration parameter changes, removals, and additions in Cosmos EVM v0.5.0"
---

<Warning>
**Breaking Configuration Changes**

v0.5.0 introduces breaking changes to genesis parameters, application configuration, and mempool settings. Review all changes carefully before upgrading.
</Warning>

## Genesis Parameter Changes

### VM Module Parameters

#### REMOVED: allow_unprotected_txs

**What Changed:**
- Parameter completely removed from VM module genesis parameters
- Non-EIP-155 transaction acceptance now managed per-node via `app.toml`
- No longer a consensus parameter

**Before (v0.4.x):**
```json
{
  "app_state": {
    "vm": {
      "params": {
        "evm_denom": "atest",
        "extra_eips": [],
        "allow_unprotected_txs": false,  // ← REMOVED
        "evm_channels": [],
        "access_control": {...},
        "active_static_precompiles": [...]
      }
    }
  }
}
```

**After (v0.5.0):**
```json
{
  "app_state": {
    "vm": {
      "params": {
        "evm_denom": "atest",
        "extra_eips": [],
        "evm_channels": [],
        "access_control": {...},
        "active_static_precompiles": [...],
        "history_serve_window": 8192  // ← NEW
      }
    }
  }
}
```

#### ADDED: history_serve_window

**Purpose:** Controls EIP-2935 block hash storage depth
**Default Value:** `8192` blocks
**Type:** `uint64`
**Range:** Must be > 0, recommended ≤ 8192 for optimal performance

**Configuration:**
```json
{
  "vm": {
    "params": {
      "history_serve_window": 8192
    }
  }
}
```

**Impact:**
- Determines how many historical block hashes are accessible via `BLOCKHASH` opcode
- Higher values increase storage requirements
- Lower values reduce block hash availability for smart contracts

---

## Application Configuration (app.toml)

### JSON-RPC Section Updates

#### allow-unprotected-txs Migration

**What Changed:**
- Previously a global consensus parameter
- Now a per-node configuration in `app.toml`
- Allows individual node operators to choose their policy

**Configuration:**
```toml
[json-rpc]
# AllowUnprotectedTxs restricts unprotected (non EIP155 signed) transactions 
# to be submitted via the node's RPC when the global parameter is disabled.
allow-unprotected-txs = false
```

**Migration Impact:**
- **Default Value:** `false` (same as before)
- **Node Operator Control:** Each node can now decide independently
- **Security:** Maintains same security defaults while allowing flexibility

#### New Batch Processing Controls

**Added Configuration:**
```toml
[json-rpc]
# Maximum number of requests in a batch.
batch-request-limit = 1000

# Maximum number of bytes returned from a batched call.
batch-response-max-size = 25000000
```

**Purpose:**
- Prevents DoS attacks via large batch requests
- Controls memory usage during batch processing
- Aligns with Ethereum client standards (geth v1.15.11)

#### Enhanced Profiling Support

**Added Configuration:**
```toml
[json-rpc]
# Enabled profiling in the debug namespace
enable-profiling = false
```

**Security Note:**
- **Default:** `false` for security
- **Production:** Should remain `false` on public nodes
- **Development:** Can be enabled for debugging and optimization

---

## Mempool Configuration Changes

### BREAKING: EVMMempoolConfig Structure

**Previous Architecture (v0.4.x):**
```go
// Pre-built pools passed directly
mempoolConfig := &evmmempool.EVMMempoolConfig{
    TxPool:     customTxPool,      // ← REMOVED
    CosmosPool: customCosmosPool,  // ← REMOVED
    AnteHandler: app.GetAnteHandler(),
}
```

**New Architecture (v0.5.0):**
```go
// Configuration objects instead of pre-built pools
mempoolConfig := &evmmempool.EVMMempoolConfig{
    LegacyPoolConfig: &legacypool.Config{     // ← NEW
        PriceLimit: 2,
        AccountSlots: 16,
        GlobalSlots: 4096,
        AccountQueue: 64,
        GlobalQueue: 1024,
        Lifetime: 3 * time.Hour,
    },
    CosmosPoolConfig: &sdkmempool.PriorityNonceMempoolConfig[math.Int]{ // ← NEW
        TxPriority: sdkmempool.TxPriority[math.Int]{
            GetTxPriority: customPriorityFunc,
            Compare: math.IntComparator,
            MinValue: math.ZeroInt(),
        },
    },
    AnteHandler:   app.GetAnteHandler(),
    BroadCastTxFn: customBroadcastFunc, // ← OPTIONAL
    BlockGasLimit: 100_000_000,         // ← NEW
}
```

### Default Configuration Handling

**Automatic Defaults:**
```go
// If configs are nil, sensible defaults are used
mempoolConfig := &evmmempool.EVMMempoolConfig{
    LegacyPoolConfig: nil, // Uses legacypool.DefaultConfig
    CosmosPoolConfig: nil, // Uses default priority mempool
    AnteHandler:      app.GetAnteHandler(),
    BlockGasLimit:    0,   // Auto-sets to 100_000_000
}
```

**Configuration Details:**

#### LegacyPoolConfig Options
```go
type Config struct {
    Locals    []common.Address // Addresses that should be treated as local (no gas limit)
    NoLocals  bool            // Whether local transaction handling is disabled
    Journal   string          // Journal of local transactions to survive node restarts
    Rejournal time.Duration   // Time interval to regenerate the local transaction journal

    PriceLimit uint64 // Minimum gas price to enforce for acceptance into the pool
    PriceBump  uint64 // Minimum price bump percentage to replace an already existing transaction (nonce)

    AccountSlots uint64 // Number of executable transaction slots guaranteed per account
    GlobalSlots  uint64 // Maximum number of executable transaction slots for all accounts
    AccountQueue uint64 // Maximum number of non-executable transaction slots permitted per account
    GlobalQueue  uint64 // Maximum number of non-executable transaction slots for all accounts

    Lifetime time.Duration // Maximum amount of time non-executable transaction are queued
}
```

#### CosmosPoolConfig Options
```go
type PriorityNonceMempoolConfig[C comparable] struct {
    TxPriority TxPriority[C]
    OnRead     func(tx sdk.Tx)
    TxReplacement TxReplacement[C]
}

type TxPriority[C comparable] struct {
    GetTxPriority func(goCtx context.Context, tx sdk.Tx) C
    Compare       func(a, b C) int
    MinValue      C
}
```

---

## Transaction Response Changes

### ADDED: max_used_gas Field

**New Field in MsgEthereumTxResponse:**
```protobuf
message MsgEthereumTxResponse {
  string hash = 1;
  repeated Log logs = 2;
  bytes ret = 3;
  string vm_error = 4;
  uint64 gas_used = 5;
  uint64 max_used_gas = 6;  // ← NEW: gas consumed without refunds
}
```

**Purpose:**
- Tracks gas consumption before refunds for optimization
- Enables better gas estimation algorithms
- Provides more detailed gas usage analytics

### ADDED: block_timestamp Field in Logs

**Enhanced Log Structure:**
```protobuf
message Log {
  string address = 1;
  repeated string topics = 2;
  bytes data = 3;
  uint64 block_number = 4;
  string tx_hash = 5;
  uint64 tx_index = 6;
  string block_hash = 7;
  uint64 index = 8;
  bool removed = 9;
  uint64 block_timestamp = 10;  // ← NEW: block timestamp
}
```

**Impact:**
- Event listeners now receive block timestamps
- Improved debugging and analytics capabilities
- Better alignment with Ethereum log structure

---

## RPC Configuration Updates

### New API Method Support

**eth_createAccessList:**
- Automatically enabled in default API namespace
- No additional configuration required
- Supports transaction optimization features

### Enhanced Error Handling

**Improved Response Handling:**
- Better error propagation in RPC responses  
- Enhanced debugging information
- More detailed gas estimation feedback

---

## Global Mempool Registry Removal

### BREAKING: Singleton Pattern Eliminated

**What Was Removed:**
```go
// These functions no longer exist:
mempool.SetGlobalEVMMempool(evmMempool)  // ← REMOVED
mempool.GetGlobalEVMMempool()            // ← REMOVED
```

**Migration Required:**

**Before (v0.4.x):**
```go
// Global registry approach
mempool.SetGlobalEVMMempool(evmMempool)

// JSON-RPC server accessed global mempool
jsonRPCServer, err := jsonrpc.StartJSONRPC(ctx, clientCtx, logger, config, indexer)
```

**After (v0.5.0):**
```go
// Direct injection approach
jsonRPCServer, err := jsonrpc.StartJSONRPC(
    ctx,
    clientCtx, 
    logger.With("module", "jsonrpc"),
    evmMempool, // ← Pass mempool directly
    config,
    indexer,
)
```

---

## Configuration Migration Checklist

### Genesis File Updates

- [ ] Remove `allow_unprotected_txs` from VM parameters
- [ ] Add `history_serve_window: 8192` to VM parameters  
- [ ] Validate updated genesis with `evmd validate-genesis`

### app.toml Updates  

- [ ] Ensure `allow-unprotected-txs = false` in `[json-rpc]` section
- [ ] Configure `batch-request-limit = 1000` if not present
- [ ] Configure `batch-response-max-size = 25000000` if not present
- [ ] Set `enable-profiling = false` for production nodes

### Code Updates

- [ ] Update mempool initialization to use configuration objects
- [ ] Remove global mempool registry calls
- [ ] Pass mempool directly to JSON-RPC server
- [ ] Update precompile constructors to use keeper interfaces

### Validation Steps

```bash
# 1. Validate genesis changes
evmd validate-genesis genesis.json

# 2. Check parameter migration
evmd query vm params

# 3. Test RPC functionality
curl -X POST \
  -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"eth_chainId","params":[],"id":1}' \
  http://localhost:8545

# 4. Test new RPC methods
curl -X POST \
  -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"eth_createAccessList","params":[...],"id":1}' \
  http://localhost:8545
```

---

## Default Value Reference

### VM Parameters
```json
{
  "evm_denom": "atest",
  "extra_eips": [],
  "evm_channels": [],
  "access_control": {
    "create": {
      "access_type": "ACCESS_TYPE_PERMISSIONLESS",
      "access_control_list": []
    },
    "call": {
      "access_type": "ACCESS_TYPE_PERMISSIONLESS", 
      "access_control_list": []
    }
  },
  "active_static_precompiles": [],
  "history_serve_window": 8192
}
```

### JSON-RPC Configuration
```toml
[json-rpc]
enable = false
api = ["eth", "net", "web3"]
address = "127.0.0.1:8545"
ws-address = "127.0.0.1:8546"
gas-cap = 25000000
allow-insecure-unlock = true
evm-timeout = "5s"
txfee-cap = 1.0
filter-cap = 200
feehistory-cap = 100
logs-cap = 10000
block-range-cap = 10000
http-timeout = "30s"
http-idle-timeout = "120s"
allow-unprotected-txs = false
batch-request-limit = 1000
batch-response-max-size = 25000000
max-open-connections = 0
enable-indexer = false
metrics-address = "127.0.0.1:6065"
fix-revert-gas-refund-height = 0
ws-origins = ["127.0.0.1", "localhost"]
enable-profiling = false
```

### Mempool Configuration
```go
// Default legacy pool config
legacypool.Config{
    Locals: nil,
    NoLocals: false,
    Journal: "",
    Rejournal: 0,
    PriceLimit: 1,
    PriceBump: 10,
    AccountSlots: 16,
    GlobalSlots: 4096,
    AccountQueue: 64, 
    GlobalQueue: 1024,
    Lifetime: 3 * time.Hour,
}

// Default cosmos pool uses priority nonce mempool with default settings
```

---

## Performance Impact

### Gas Estimation Optimization

**Configuration Impact:**
- `history_serve_window` affects `BLOCKHASH` opcode performance
- Larger values increase storage but improve contract compatibility
- Recommended to keep at default `8192` unless specific requirements

### Mempool Performance

**Configuration-Based Benefits:**
- Fine-tuned pool parameters improve transaction throughput
- Configurable broadcast functions enable custom propagation logic
- Better resource management through explicit limits

### RPC Performance

**Batch Processing Controls:**
- `batch-request-limit` prevents resource exhaustion
- `batch-response-max-size` controls memory usage
- Proper tuning improves node stability under load

---

## Migration Examples by Use Case

### Standard Chain Migration

**Minimal Changes Required:**
```bash
# 1. Update genesis.json
jq 'del(.app_state.vm.params.allow_unprotected_txs) | 
    .app_state.vm.params.history_serve_window = 8192' \
    genesis.json > genesis-v0.5.0.json

# 2. app.toml already has correct defaults
# 3. Code uses default mempool configuration - no changes needed
```

### Custom Mempool Migration

**Before (v0.4.x):**
```go
// Custom pools created manually
customTxPool := CreateCustomTxPool(...)
customCosmosPool := CreateCustomCosmosPool(...)

mempoolConfig := &evmmempool.EVMMempoolConfig{
    TxPool:     customTxPool,
    CosmosPool: customCosmosPool,
    AnteHandler: app.GetAnteHandler(),
}
```

**After (v0.5.0):**
```go
// Configuration-based approach
mempoolConfig := &evmmempool.EVMMempoolConfig{
    LegacyPoolConfig: &legacypool.Config{
        PriceLimit:   customPriceLimit,
        AccountSlots: customAccountSlots,
        GlobalSlots:  customGlobalSlots,
        // ... other custom settings
    },
    CosmosPoolConfig: &sdkmempool.PriorityNonceMempoolConfig[math.Int]{
        TxPriority: sdkmempool.TxPriority[math.Int]{
            GetTxPriority: customPriorityFunction,
            Compare:       math.IntComparator,
            MinValue:      math.ZeroInt(),
        },
    },
    AnteHandler:   app.GetAnteHandler(),
    BroadCastTxFn: customBroadcastFunction,
    BlockGasLimit: customBlockGasLimit,
}
```

### High-Performance Node Configuration

**Optimized app.toml Settings:**
```toml
[json-rpc]
# Increase batch limits for high-throughput applications
batch-request-limit = 5000
batch-response-max-size = 100000000

# Optimize timeouts for faster response
evm-timeout = "3s"
http-timeout = "20s"
http-idle-timeout = "60s"

# Increase filter and log caps for analytics workloads
filter-cap = 1000
logs-cap = 50000
block-range-cap = 50000

# Enable metrics for monitoring
metrics-address = "0.0.0.0:6065"
```

**Corresponding Genesis Settings:**
```json
{
  "vm": {
    "params": {
      "history_serve_window": 4096  // Reduce for better performance
    }
  }
}
```

---

## Verification Commands

### Pre-Migration State Capture

```bash
# Capture current VM parameters
evmd query vm params > pre-upgrade-vm-params.json

# Export full genesis for comparison
evmd export > pre-upgrade-genesis.json

# Check current mempool status (if accessible)
curl -s -X POST \
  -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"txpool_status","params":[],"id":1}' \
  http://localhost:8545
```

### Post-Migration Verification

```bash
# 1. Verify parameter changes
evmd query vm params
# Should show history_serve_window and no allow_unprotected_txs

# 2. Test EIP-2935 functionality
cast call --rpc-url http://localhost:8545 \
  $CONTRACT_ADDRESS "getBlockHash(uint256)" $RECENT_BLOCK_NUMBER

# 3. Test new RPC methods
curl -X POST \
  -H "Content-Type: application/json" \
  --data '{
    "jsonrpc":"2.0",
    "method":"eth_createAccessList",
    "params":[{
      "to":"0x...",
      "data":"0x..."
    },"latest"],
    "id":1
  }' \
  http://localhost:8545

# 4. Verify mempool configuration
curl -s -X POST \
  -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"txpool_status","params":[],"id":1}' \
  http://localhost:8545

# 5. Test batch processing limits
curl -X POST \
  -H "Content-Type: application/json" \
  --data '[
    {"jsonrpc":"2.0","method":"eth_chainId","params":[],"id":1},
    {"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":2}
  ]' \
  http://localhost:8545
```

---

## Troubleshooting Configuration Issues

### Genesis Validation Errors

**Error:** `unknown field 'allow_unprotected_txs'`
```bash
# Remove the field from genesis
jq 'del(.app_state.vm.params.allow_unprotected_txs)' genesis.json > fixed-genesis.json
```

**Error:** `missing field 'history_serve_window'`  
```bash
# Add the default value
jq '.app_state.vm.params.history_serve_window = 8192' genesis.json > fixed-genesis.json
```

### Mempool Configuration Errors

**Error:** `config must not be nil`
```go
// Always provide configuration object
config := &evmmempool.EVMMempoolConfig{
    AnteHandler:   app.GetAnteHandler(),
    BlockGasLimit: 100_000_000, // Required
}
```

**Error:** `cannot use concrete keeper type`
```go
// Cast keepers to interfaces
precompile, err := someprecompile.NewPrecompile(
    common.BankKeeper(app.BankKeeper), // Cast to interface
    // ... other parameters
)
```

### RPC Configuration Issues

**Error:** `cannot enable JSON-RPC without defining any API namespace`
```toml
[json-rpc]
enable = true
api = ["eth", "net", "web3"]  # Must specify at least one namespace
```

**Error:** `batch response size exceeded`
```toml
[json-rpc]
# Increase limits if legitimate large responses are needed
batch-response-max-size = 50000000
```

---

## Security Considerations

### Per-Node Unprotected Transactions

**Risk Assessment:**
- `allow-unprotected-txs = true` accepts non-EIP-155 transactions
- Increases replay attack surface
- **Recommendation:** Keep `false` unless specific compatibility requirements

### Profiling Security

**Production Settings:**
```toml
[json-rpc]
enable-profiling = false  # NEVER enable on public nodes
```

**Development Settings:**
```toml  
[json-rpc]
enable-profiling = true   # OK for private development nodes
```

### Batch Processing Limits

**DoS Protection:**
```toml
[json-rpc]
batch-request-limit = 1000      # Prevent batch DoS
batch-response-max-size = 25000000  # Limit memory usage
max-open-connections = 100      # Limit concurrent connections  
```

This comprehensive configuration guide covers all the parameter changes, new settings, and migration requirements for v0.5.0. The configuration changes maintain backward compatibility where possible while providing new optimization and security features.